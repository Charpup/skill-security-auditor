# SDD Specification for skill-security-auditor
# Specification-Driven Development for OpenClaw Security
# Updated: 2026-02-11 - Cisco Skill Scanner Integration

spec_version: "1.1"
module_name: "skill-security-auditor"
description: "OpenClaw skill security auditor integrating Cisco Skill Scanner for comprehensive skill security assessment"
version: "1.1.0"
author: "Galatea / OpenClaw Team"
date: "2026-02-11"

# Project context
context:
  purpose: "Protect OpenClaw ecosystem from malicious skills through Cisco AI Skill Scanner static analysis"
  target_users: "OpenClaw users, skill developers, security auditors"
  background: "Post-Claude Audit - Migrated from AgentVerus to Cisco Skill Scanner for unified Python stack"

# Architecture
architecture:
  type: "layered"
  layers:
    - name: "Static Analysis Layer"
      role: "Pre-install/CI scanning using Cisco Skill Scanner (AITech taxonomy, SARIF output)"
    - name: "Threat Intelligence Layer"  
      role: "Continuous CVE monitoring via ClawSec Feed (SHA256 verification)"
    - name: "Orchestration Layer"
      role: "Unified CLI, report aggregation, auto-remediation"

# Interface definitions - CORE OF SDD
interfaces:
  - name: "ScannerOrchestrator"
    type: "class"
    description: "Main controller coordinating all security scanners"
    
    methods:
      - name: "scan_skill"
        signature: "(skill_path: str, scanners: list[str] = None) -> ScanResult"
        description: "Run security scan on a single skill using specified scanners"
        
        contract:
          preconditions:
            - "skill_path exists and is readable"
            - "scanners is subset of [cisco, clawsec] or None (all)"
          postconditions:
            - "returns ScanResult with findings from all requested scanners"
            - "ScanResult contains severity summary (critical/high/medium/low/info)"
        
        test_cases:
          - id: "TC-001"
            name: "Scan clean skill"
            input:
              skill_path: "./skills/legitimate-skill"
              scanners: ["cisco"]
            expected:
              success: true
              findings_count: 0
              severity: "none"
              
          - id: "TC-002"
            name: "Scan malicious skill - credential harvesting"
            input:
              skill_path: "./skills/malicious-credential-harvester"
              scanners: ["cisco", "clawsec"]
            expected:
              success: true
              findings_count: ">= 1"
              severity: "critical"
              attack_types: ["credential_harvesting"]
              
          - id: "TC-003"
            name: "Invalid skill path"
            input:
              skill_path: "./nonexistent-skill"
              scanners: ["cisco"]
            expected:
              exception: "FileNotFoundError"
              message_contains: "Skill path not found"

      - name: "scan_all_skills"
        signature: "(skills_dir: str = None) -> BulkScanResult"
        description: "Scan all installed skills in parallel"
        
        contract:
          preconditions:
            - "skills_dir is valid directory or None (uses default)"
          postconditions:
            - "returns aggregated results for all skills"
            - "failed_scans list contains any scan failures"
        
        test_cases:
          - id: "TC-004"
            name: "Bulk scan with mixed results"
            input:
              skills_dir: "./skills/"
            expected:
              success: true
              total_scanned: ">= 0"
              critical_findings: ">= 0"
              failed_scans: []

  - name: "CiscoSkillScanner"
    type: "class"
    description: "Wrapper for Cisco AI Skill Scanner (AITech taxonomy-based static analysis)"
    
    methods:
      - name: "scan"
        signature: "(skill_path: str, severity_threshold: str = 'medium') -> List[Finding]"
        description: "Execute Cisco Skill Scanner and parse SARIF output"
        
        contract:
          preconditions:
            - "cisco-ai-skill-scanner is installed (pip install cisco-ai-skill-scanner[all])"
            - "severity_threshold in [low, medium, high, critical]"
          postconditions:
            - "returns list of Finding objects"
            - "each Finding contains AITech attack_type classification"
        
        test_cases:
          - id: "TC-CS-001"
            name: "Detect prompt injection"
            input:
              skill_path: "./test-skills/prompt-injection"
              severity_threshold: "medium"
            expected:
              findings:
                - attack_type: "prompt_injection"
                  severity: "high"
                  
          - id: "TC-CS-002"
            name: "Detect data exfiltration"
            input:
              skill_path: "./test-skills/data-exfil"
            expected:
              findings:
                - attack_type: "data_exfiltration"
                  severity: "critical"
                  
          - id: "TC-CS-003"
            name: "Detect all AITech threat categories"
            input:
              skill_path: "./test-skills/comprehensive-test"
            expected:
              attack_types_detected: ">= 8"
              attack_types:
                - prompt_injection
                - data_exfiltration
                - credential_harvesting
                - command_injection
                - dependency_confusion
                - malicious_code_execution
                - network_egress
                - privilege_escalation

      - name: "get_version"
        signature: "() -> str"
        description: "Get Cisco Skill Scanner version"
        
        contract:
          postconditions:
            - "returns version string of installed scanner"

  - name: "ClawSecIntegration"
    type: "class"
    description: "Integration with ClawSec Feed for threat intelligence"
    
    methods:
      - name: "check_cve_database"
        signature: "(skill_name: str) -> List[ThreatIntel]"
        description: "Query ClawSec CVE database for skill vulnerabilities"
        
        contract:
          preconditions:
            - "skill_name is non-empty string"
          postconditions:
            - "returns list of CVE entries affecting the skill"
            - "empty list if no known vulnerabilities"
        
        test_cases:
          - id: "TC-CLAW-001"
            name: "Known vulnerable skill"
            input:
              skill_name: "vulnerable-skill-v1.0"
            expected:
              threats:
                - cve_id: "CVE-2025-XXXX"
                  severity: "critical"
                  
          - id: "TC-CLAW-002"
            name: "Clean skill"
            input:
              skill_name: "clean-skill-v1.0"
            expected:
              threats: []
              
      - name: "verify_checksum"
        signature: "(skill_path: str, expected_hash: str) -> bool"
        description: "Verify skill integrity using SHA256"
        
        contract:
          preconditions:
            - "skill_path exists"
            - "expected_hash is valid SHA256 hex string"
          postconditions:
            - "returns True if computed hash matches expected"
            - "returns False and logs mismatch if different"
        
        test_cases:
          - id: "TC-CLAW-003"
            name: "Valid checksum"
            input:
              skill_path: "./skills/verified-skill"
              expected_hash: "abc123..."
            expected:
              valid: true
              
          - id: "TC-CLAW-004"
            name: "Tampered skill"
            input:
              skill_path: "./skills/tampered-skill"
              expected_hash: "abc123..."
            expected:
              valid: false
              alert_raised: true

  - name: "ReportGenerator"
    type: "class"
    description: "Generate security reports in multiple formats"
    
    methods:
      - name: "generate_sarif"
        signature: "(scan_result: ScanResult, output_path: str) -> None"
        description: "Generate SARIF 2.1.0 report for GitHub integration"
        
        contract:
          preconditions:
            - "scan_result is valid ScanResult object"
            - "output_path is writable"
          postconditions:
            - "SARIF file created at output_path"
            - "Valid SARIF 2.1.0 format"
        
        test_cases:
          - id: "TC-RG-001"
            name: "Generate SARIF with findings"
            input:
              scan_result:
                findings:
                  - severity: "critical"
                    rule_id: "AITech-001"
              output_path: "./report.sarif"
            expected:
              file_created: true
              valid_sarif: true
              sarif_version: "2.1.0"
              
      - name: "generate_markdown"
        signature: "(scan_result: ScanResult) -> str"
        description: "Generate human-readable Markdown report"
        
        contract:
          preconditions:
            - "scan_result is valid"
          postconditions:
            - "returns Markdown string with findings summary"
        
        test_cases:
          - id: "TC-RG-002"
            name: "Markdown report structure"
            input:
              scan_result:
                skill_name: "test-skill"
                findings_count: 3
            expected:
              markdown_contains:
                - "# Security Audit Report"
                - "## Summary"
                - "## Findings"
                - "## Recommendations"

      - name: "generate_json"
        signature: "(scan_result: ScanResult) -> str"
        description: "Generate JSON report for programmatic consumption"
        
        contract:
          postconditions:
            - "returns valid JSON string"

# Data structures
data_structures:
  - name: "Finding"
    type: "dataclass"
    fields:
      - name: "rule_id"
        type: "str"
        description: "AITech rule identifier"
      - name: "attack_type"
        type: "str"
        description: "AITech attack classification"
      - name: "severity"
        type: "str"
        description: "One of: critical, high, medium, low, info"
      - name: "message"
        type: "str"
        description: "Human-readable description"
      - name: "file_path"
        type: "str"
        description: "Path to affected file"
      - name: "line_number"
        type: "int"
        description: "Line number of issue"
      - name: "confidence"
        type: "float"
        description: "Detection confidence 0.0-1.0"

  - name: "ScanResult"
    type: "dataclass"
    fields:
      - name: "skill_name"
        type: "str"
      - name: "skill_path"
        type: "str"
      - name: "scan_time"
        type: "datetime"
      - name: "findings"
        type: "List[Finding]"
      - name: "severity_counts"
        type: "Dict[str, int]"
      - name: "scanners_used"
        type: "List[str]"

# Behavior scenarios - BDD style
scenarios:
  - id: "E2E-001"
    name: "Complete skill installation security workflow"
    priority: high
    
    given:
      - condition: "User wants to install a new skill from ClawHub"
      - condition: "skill-security-auditor is installed and configured"
      
    when:
      - action: "User runs 'claw-audit scan <skill-path>'"
      - action: "System validates skill structure"
      - action: "Cisco Skill Scanner performs static analysis"
      - action: "ClawSec checks CVE database"
      - action: "SHA256 checksum is verified"
      
    then:
      - expectation: "Report shows all findings by severity"
      - expectation: "If critical findings exist, installation is blocked"
      - expectation: "If high findings exist, user is warned"
      - expectation: "SARIF 2.1.0 report is generated for CI integration"
      
    quality_attributes:
      - name: "scan_time"
        threshold: "< 30 seconds"
      - name: "false_positive_rate"
        threshold: "< 5%"

  - id: "E2E-002"
    name: "Bulk audit of all installed skills"
    priority: medium
    
    given:
      - condition: "User has 50+ skills installed"
      - condition: "New CVE is published affecting multiple skills"
      
    when:
      - action: "ClawSec Feed detects new CVE"
      - action: "System runs 'claw-audit scan-all'"
      - action: "Parallel scanning of all skills"
      
    then:
      - expectation: "All affected skills are identified"
      - expectation: "Aggregate report shows risk summary"
      - expectation: "Auto-remediation isolates high-risk skills"

  - id: "E2E-003"
    name: "CI/CD integration for skill publishing"
    priority: medium
    
    given:
      - condition: "Developer is publishing skill to ClawHub"
      - condition: "GitHub Actions workflow is configured"
      
    when:
      - action: "Push triggers GitHub Actions"
      - action: "skill-security-auditor runs in CI mode"
      - action: "SARIF output uploaded to GitHub Security tab"
      
    then:
      - expectation: "Build fails if critical findings detected"
      - expectation: "Security tab shows detailed findings"
      - expectation: "PR is blocked until issues resolved"

  - id: "E2E-004"
    name: "Testing with known malicious samples"
    priority: high
    
    given:
      - condition: "10 known malicious skill samples available"
      - condition: "Cisco Skill Scanner is properly configured"
      
    when:
      - action: "Run scanner against each malicious sample"
      - action: "Record detection results"
      
    then:
      - expectation: "Detection rate >= 90% for known malicious patterns"
      - expectation: "All critical severity issues are flagged"
      - expectation: "Results documented in test report"

# Acceptance criteria
acceptance_criteria:
  functional:
    - "All AITech threat categories are detectable"
    - "Scan completes in < 30 seconds per skill"
    - "False positive rate < 5%"
    - "Detection rate > 90% for known malicious samples"
    - "SARIF 2.1.0 output is GitHub Code Scanning compatible"
    
  non_functional:
    - "Memory usage < 200MB peak during scan"
    - "Supports 50+ concurrent skill scans"
    - "Offline mode works with cached threat intelligence"
    - "Graceful degradation if external feeds unavailable"

# Configuration
config:
  environment_variables:
    required:
      - name: "OPENCLAW_SKILLS_DIR"
        description: "Path to OpenClaw skills directory"
    optional:
      - name: "CISCO_SCANNER_THRESHOLD"
        description: "Minimum severity to report"
        default: "medium"
      - name: "CLAWSEC_FEED_URL"
        description: "ClawSec threat intelligence feed URL"
        default: "https://api.clawsec.io/v1/feed"
      - name: "AUDIT_AUTO_REMEDIATE"
        description: "Enable automatic isolation of suspicious skills"
        default: "false"
      - name: "AUDIT_OUTPUT_FORMAT"
        description: "Default output format (sarif, markdown, json)"
        default: "markdown"

# Dependencies
dependencies:
  runtime:
    - package: "cisco-ai-skill-scanner"
      version: ">=0.1.0"
      install: "pip install cisco-ai-skill-scanner[all]"
  development:
    - package: "pytest"
      version: ">=7.0.0"
    - package: "pytest-asyncio"
      version: ">=0.21.0"
    - package: "pytest-cov"
      version: ">=4.0.0"
    - package: "sarif-om"
      version: ">=1.0.4"
      description: "SARIF output model"

# Testing strategy
testing_strategy:
  unit_tests:
    focus: "Individual scanner wrappers, parsers, formatters"
    coverage_target: 85
  integration_tests:
    focus: "Scanner coordination, database operations, external API mocking"
    coverage_target: 75
  acceptance_tests:
    focus: "End-to-end workflows with test skill repository"
    coverage_target: "all E2E scenarios pass"
  security_tests:
    focus: "Test with known malicious skill samples"
    samples: 
      - "prompt-injection-skill"
      - "credential-harvester-skill"
      - "data-exfiltration-skill"
      - "command-injection-skill"
      - "dependency-confusion-skill"
      - "malicious-code-execution-skill"
      - "network-egress-skill"
      - "privilege-escalation-skill"
      - "obfuscation-skill"
      - "backdoor-skill"
    detection_target: ">= 90%"
